<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/default.min.css" charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js" charset="UTF-8"></script>    

    <script>
        hljs.initHighlightingOnLoad();
        document.querySelectorAll('code').forEach(function(block) {
            block.insertAdjacentHTML('beforebegin', '<button class="copy-button" onclick="copyToClipboard(this)">Copy</button>');
        });
        function copyToClipboard(button) {
            var code = button.nextElementSibling.innerText;
            navigator.clipboard.writeText(code).then(function() {
                button.innerText = "Copied!";
                setTimeout(function() {
                    button.innerText = "Copy";
                }, 2000);
            }, function() {
                button.innerText = "Error";
            });
        }
    </script>
    
    <script>
        function showAlert() {
            alert("Warning: The specified environment variable was not found!");
        }
    
        function showQuitPrompt() {
            document.getElementById('quit-prompt').style.display = 'block';
        }
    
        function hideQuitPrompt() {
            document.getElementById('quit-prompt').style.display = 'none';
        }
    
        function quitStudy() {
            // Logic to exit and close the application
            window.close(); // This will close the current window/tab
        }
    </script>

</head>
<body>
    <header class="header">
        <div class="website-name">
            <h1>Australian Institute for Machine Learning <br> Beta Wordie.AI</h1>
        </div>
    </header>
    <div class="main-container">
        <aside class="sidebar">
            <ul>
                <li><button class="quit-button" onclick="showQuitPrompt()">Quit Study</button></li>
            </ul>
            <h2>Sidebar</h2>
            <ul>
                <li><button class="redirection-button">Next <br>(back to survey)</button></li>
            </ul>
        </aside>
        <div class="right-container">
            <main class="chat-area">
                <div class="chat-messages-container" id="chat-messages-container">
                    {% for message in messages %}
                    {% if message['role'] == "user" %}
                        <div class="chat-bubble user-message">
                            <span class="user-label">User</span>
                            {% if show_popup %}
                            <script>showAlert();</script>
                            {% endif %}
                            {{ message['content']|safe }}
                        </div>
                    {% endif %}
                    {% if message['role'] == "assistant" %}
                        <div class="chat-bubble llm-message">
                            <span class="assistant-label">AI</span>
                            {{ message['content']|safe }}
                        </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </main>
            <div class="chat-input">
                <form id="chat-form" method="POST" action="{{ url_for('chat') }}">
                    <input type="text" id="chat-input" class="text-input" name="message" placeholder="Type your message here...">
                    <button class="submit-button" type="submit">Submit</button>
                </form>
            </div>
        </div>
    </div>
    <div id="loading-indicator" class="loading" style="display: none;">
        <span></span><span></span><span></span>
    </div>
    <div id="quit-prompt">
        <p>Are you sure you want to withdraw from the study?</p>
        <p>If so, you will not receive reimbursement for participation.</p>
        <button onclick="quitStudy()">Yes, I want to withdraw</button>
        <button onclick="hideQuitPrompt()">No, I want to continue</button>
    </div>
    <script>
        document.getElementById('chat-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const inputField = document.getElementById('chat-input');
            const form = event.target;
            const chatMessagesContainer = document.getElementById('chat-messages-container');

            // Append the user message immediately
            const userMessage = document.createElement('div');
            userMessage.className = 'chat-bubble user-message';
            userMessage.innerHTML = '<span class="user-label">User</span>' + inputField.value;
            chatMessagesContainer.appendChild(userMessage);

            // Create a container for the assistant's response
            const assistantResponseContainer = document.createElement('div');
            assistantResponseContainer.className = 'chat-bubble llm-message';
            assistantResponseContainer.innerHTML = '<span class="assistant-label">AI</span>';
            chatMessagesContainer.appendChild(assistantResponseContainer);

            // Create and append the loading indicator inside the assistant's response container
            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'loading-indicator';
            loadingIndicator.className = 'loading';
            loadingIndicator.innerHTML = '<span></span><span></span><span></span>';
            assistantResponseContainer.appendChild(loadingIndicator);

            // Generate a random wait time between 2 and 6 seconds
            const waitTime = Math.floor(Math.random() * 2500) + 600;

            setTimeout(() => {
                fetch(form.action, {
                    method: form.method,
                    body: new FormData(form)
                }).then(response => response.text())
                  .then(html => {
                      const parser = new DOMParser();
                      const doc = parser.parseFromString(html, 'text/html');
                      const newMessages = doc.getElementById('chat-messages-container').innerHTML;
                      document.getElementById('chat-messages-container').innerHTML = newMessages;
                      inputField.value = '';
                      inputField.focus();

                      // Remove the loading indicator
                      loadingIndicator.remove();
                  });
            }, waitTime);
        });

        document.getElementById('chat-input').focus();
    </script>
</body>
</html>